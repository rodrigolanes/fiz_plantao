name: Promote to Production
on:
  workflow_dispatch:
    inputs:
      version_code:
        description: 'Version code to promote from internal testing'
        required: true
        type: string

jobs:
  promote:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      # Setup Ruby to use Fastlane Supply for promotion
      - name: Setup Ruby
        uses: ruby/setup-ruby@v1
        with:
          ruby-version: '3.3'

      - name: Install Fastlane
        run: |
          gem install fastlane -NV

      - name: Write Google Service Account JSON
        env:
          SERVICE_ACCOUNT_JSON: ${{ secrets.SERVICE_ACCOUNT_JSON }}
        run: |
          echo "$SERVICE_ACCOUNT_JSON" > service_account.json

      - name: Promote Internal -> Production
        env:
          VERSION_CODE: ${{ inputs.version_code }}
        run: |
          # Promote existing release from Internal to Production using Fastlane Supply
          fastlane supply \
            --json_key service_account.json \
            --package_name br.com.rodrigolanes.fizplantao \
            --skip_upload_apk true \
            --skip_upload_aab true \
            --skip_upload_metadata true \
            --skip_upload_images true \
            --skip_upload_screenshots true \
            --track internal \
            --track_promote_to production \
            --version_codes $VERSION_CODE \
            --release_status completed

      - name: Verify Tracks - Version Codes
        run: |
          echo "Production track version codes:"
          fastlane run google_play_track_version_codes json_key:service_account.json package_name:br.com.rodrigolanes.fizplantao track:production
          echo "Internal track version codes:"
          fastlane run google_play_track_version_codes json_key:service_account.json package_name:br.com.rodrigolanes.fizplantao track:internal

      - name: Verify Tracks - Release Names (Production)
        run: |
          fastlane run google_play_track_release_names json_key:service_account.json package_name:br.com.rodrigolanes.fizplantao track:production


