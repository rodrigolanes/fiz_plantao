name: Deploy Internal Testing
on:
  workflow_dispatch:
    inputs:
      version_bump:
        description: 'Tipo de incremento de versão'
        required: true
        default: 'patch'
        type: choice
        options:
          - patch
          - minor
          - major

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Increment Version
        id: version
        run: |
          # Ler versão atual
          current_version=$(grep '^version:' pubspec.yaml | sed 's/version: //')
          version_name=$(echo $current_version | cut -d'+' -f1)
          build_number=$(echo $current_version | cut -d'+' -f2)
          
          # Incrementar build number
          new_build=$((build_number + 1))
          
          # Incrementar version name baseado no input
          IFS='.' read -r major minor patch <<< "$version_name"
          case "${{ github.event.inputs.version_bump }}" in
            major)
              major=$((major + 1))
              minor=0
              patch=0
              ;;
            minor)
              minor=$((minor + 1))
              patch=0
              ;;
            patch)
              patch=$((patch + 1))
              ;;
          esac
          
          new_version="${major}.${minor}.${patch}+${new_build}"
          echo "new_version=$new_version" >> $GITHUB_OUTPUT
          echo "Nova versão: $new_version"
          
          # Atualizar pubspec.yaml
          sed -i "s/^version: .*/version: $new_version/" pubspec.yaml
          
          # Configurar git
          git config user.name "GitHub Actions"
          git config user.email "actions@github.com"
          
          # Commit e push
          git add pubspec.yaml
          git commit -m "chore: bump version to $new_version [skip ci]"
          git push

      - name: Setup Java
        uses: actions/setup-java@v4
        with:
          distribution: "temurin"
          java-version: "17"

      - name: Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: "3.35.6"
          channel: "stable"
          cache: true

      - name: Verify Flutter Version
        run: |
          flutter --version
          flutter doctor -v

      - name: Decode Keystore
        run: |
          echo "${{ secrets.KEYSTORE_BASE64 }}" | base64 --decode > android/upload-keystore.jks

      - name: Create key.properties
        run: |
          cat > android/key.properties << EOF
          storePassword=${{ secrets.KEYSTORE_PASSWORD }}
          keyPassword=${{ secrets.KEY_PASSWORD }}
          keyAlias=${{ secrets.KEY_ALIAS }}
          storeFile=../upload-keystore.jks
          EOF

      - name: Create Supabase config
        run: |
          cat > lib/config/supabase_config.dart << EOF
          /// Configuração do Supabase
          /// Gerado automaticamente pelo CI (Deploy Internal)
          class SupabaseConfig {
            static const String supabaseUrl = '${{ secrets.SUPABASE_URL }}';
            static const String supabaseAnonKey = '${{ secrets.SUPABASE_ANON_KEY }}';
            static const bool enableGoogleIntegrations = true;
            static const String googleWebClientId = '${{ secrets.GOOGLE_WEB_CLIENT_ID }}';
          }
          EOF

      - name: Create google-services.json
        run: |
          echo "${{ secrets.GOOGLE_SERVICES_JSON }}" | base64 --decode > android/app/google-services.json

      - name: Flutter Pub Get
        run: flutter pub get

      - name: Run Tests
        run: flutter test --coverage

      - name: Upload Coverage
        uses: codecov/codecov-action@v3
        with:
          files: ./coverage/lcov.info
          fail_ci_if_error: false

      - name: Build AppBundle (Release)
        run: flutter build appbundle --release

      - name: Upload to Internal Track
        uses: r0adkll/upload-google-play@v1
        with:
          serviceAccountJsonPlainText: ${{ secrets.SERVICE_ACCOUNT_JSON }}
          packageName: br.com.rodrigolanes.fizplantao
          releaseFiles: build/app/outputs/bundle/release/app-release.aab
          track: internal
          status: completed
          whatsNewDirectory: android/
          mappingFile: build/app/outputs/mapping/release/mapping.txt
