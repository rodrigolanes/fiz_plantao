name: Deploy to Google Play Store (Production)

on:
  push:
    tags:
      - 'v*.*.*'  # Dispara quando criar tag como v1.8.0
  workflow_dispatch:  # Permite executar manualmente
    inputs:
      tag:
        description: 'Tag de versão (ex: v1.8.0)'
        required: true
        type: string

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout código
      uses: actions/checkout@v4
      with:
        fetch-depth: 0  # Buscar todo histórico para tags
      
    - name: Extract Version from Tag
      id: version
      run: |
        # Se for workflow_dispatch, usar input; caso contrário, usar ref da tag
        if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
          TAG="${{ github.event.inputs.tag }}"
        else
          TAG=${GITHUB_REF#refs/tags/}
        fi
        
        echo "Tag: $TAG"
        
        # Remover 'v' do início e extrair versão
        VERSION_NAME=${TAG#v}
        echo "version_name=$VERSION_NAME" >> $GITHUB_OUTPUT
        
        # Ler build number atual do pubspec.yaml
        current_version=$(grep '^version:' pubspec.yaml | sed 's/version: //')
        current_build=$(echo $current_version | cut -d'+' -f2)
        
        # Incrementar build number
        new_build=$((current_build + 1))
        echo "build_number=$new_build" >> $GITHUB_OUTPUT
        
        # Versão completa
        full_version="${VERSION_NAME}+${new_build}"
        echo "full_version=$full_version" >> $GITHUB_OUTPUT
        echo "Nova versão: $full_version"
        
        # Atualizar pubspec.yaml
        sed -i "s/^version: .*/version: $full_version/" pubspec.yaml
        
    - name: Extract Release Notes
      id: release_notes
      run: |
        VERSION="${{ steps.version.outputs.version_name }}"
        
        # Extrair notas da versão atual do RELEASE_NOTES.md
        if [ -f "RELEASE_NOTES.md" ]; then
          # Procura pela seção da versão (## Versão X.X.X)
          # e extrai até a próxima seção ou final do arquivo
          awk -v ver="$VERSION" '
            /^## Versão/ {
              if ($3 ~ ver) {
                found=1
                next
              } else if (found) {
                exit
              }
            }
            found && /^###/ { 
              # Captura subtítulos como ### ✨ Novidades
              sub(/^### /, "• ")
              print
              next
            }
            found && /^-/ {
              # Captura itens de lista
              sub(/^- /, "  - ")
              print
              next
            }
            found && /^\*\*/ {
              # Captura texto em negrito
              print
              next
            }
            found && /^$/ {
              # Pula linhas vazias entre seções
              next
            }
            found && !/^##/ && !/^---/ {
              print
            }
          ' RELEASE_NOTES.md > temp_notes.txt
          
          # Se não encontrou notas específicas, usar mensagem padrão
          if [ ! -s temp_notes.txt ]; then
            echo "Nova versão $VERSION disponível com melhorias e correções." > temp_notes.txt
          fi
          
          # Criar arquivo de release notes para Play Store (máximo 500 caracteres)
          head -c 500 temp_notes.txt > android/release-notes-pt-BR.txt
          
          cat android/release-notes-pt-BR.txt
          echo "notes_created=true" >> $GITHUB_OUTPUT
        else
          echo "Nova versão disponível" > android/release-notes-pt-BR.txt
          echo "notes_created=false" >> $GITHUB_OUTPUT
        fi
      
    - name: Setup Java
      uses: actions/setup-java@v4
      with:
        distribution: 'temurin'
        java-version: '17'
        
    - name: Setup Flutter
      uses: subosito/flutter-action@v2
      with:
        flutter-version: '3.35.6'
        channel: 'stable'
        cache: true
        
    - name: Verify Flutter Version
      run: |
        flutter --version
        flutter doctor -v
        
    - name: Instalar dependências
      run: flutter pub get
      
    - name: Decode Keystore
      run: |
        echo "${{ secrets.KEYSTORE_BASE64 }}" | base64 --decode > android/app/upload-keystore.jks
        
    - name: Criar key.properties
      run: |
        cat > android/key.properties << EOF
        storePassword=${{ secrets.KEYSTORE_PASSWORD }}
        keyPassword=${{ secrets.KEY_PASSWORD }}
        keyAlias=${{ secrets.KEY_ALIAS }}
        storeFile=../upload-keystore.jks
        EOF
        
    - name: Create Supabase config
      run: |
        cat > lib/config/supabase_config.dart << EOF
        /// Configuração do Supabase
        /// Gerado automaticamente pelo CI (Deploy Production)
        class SupabaseConfig {
          static const String supabaseUrl = '${{ secrets.SUPABASE_URL }}';
          static const String supabaseAnonKey = '${{ secrets.SUPABASE_ANON_KEY }}';
          static const bool enableGoogleIntegrations = true;
          static const String googleWebClientId = '${{ secrets.GOOGLE_WEB_CLIENT_ID }}';
        }
        EOF

    - name: Create google-services.json
      run: |
        echo "${{ secrets.GOOGLE_SERVICES_JSON }}" | base64 --decode > android/app/google-services.json
        
    - name: Run Tests
      run: flutter test --coverage
      
    - name: Upload Coverage
      uses: codecov/codecov-action@v3
      with:
        files: ./coverage/lcov.info
        fail_ci_if_error: false
        
    - name: Build App Bundle
      run: flutter build appbundle --release
      
    - name: Create native debug symbols zip
      run: |
        # Tentar encontrar os símbolos nativos em diferentes locais possíveis
        if [ -d "build/app/intermediates/merged_native_libs/release/mergeReleaseNativeLibs/out/lib" ]; then
          cd build/app/intermediates/merged_native_libs/release/mergeReleaseNativeLibs/out/lib
          zip -r $GITHUB_WORKSPACE/native-debug-symbols.zip .
        elif [ -d "build/app/intermediates/merged_native_libs/release/out/lib" ]; then
          cd build/app/intermediates/merged_native_libs/release/out/lib
          zip -r $GITHUB_WORKSPACE/native-debug-symbols.zip .
        elif [ -d "build/app/intermediates/merged_native_libs/release/lib" ]; then
          cd build/app/intermediates/merged_native_libs/release/lib
          zip -r $GITHUB_WORKSPACE/native-debug-symbols.zip .
        else
          echo "Native libs directory not found, checking alternative locations..."
          find build/app/intermediates -name "*.so" -type f | head -1 | xargs dirname | xargs -I {} sh -c 'cd {} && zip -r $GITHUB_WORKSPACE/native-debug-symbols.zip .'
        fi
        cd $GITHUB_WORKSPACE
        ls -lh native-debug-symbols.zip || echo "Warning: native-debug-symbols.zip not created"
        
    - name: Upload para Google Play Store (Production)
      uses: r0adkll/upload-google-play@v1
      with:
        serviceAccountJsonPlainText: ${{ secrets.SERVICE_ACCOUNT_JSON }}
        packageName: br.com.rodrigolanes.fizplantao
        releaseFiles: build/app/outputs/bundle/release/app-release.aab
        track: production  # Deploy direto para produção
        status: completed  # Release imediatamente
        whatsNewDirectory: android/
        mappingFile: build/app/outputs/mapping/release/mapping.txt
        debugSymbols: native-debug-symbols.zip
        
    - name: Commit Version Update
      if: success()
      run: |
        # Configurar git
        git config --global user.name 'github-actions[bot]'
        git config --global user.email '41898282+github-actions[bot]@users.noreply.github.com'
        
        # Adicionar mudanças
        git add pubspec.yaml android/release-notes-pt-BR.txt
        
        # Commit apenas se houver mudanças
        git diff --staged --quiet || git commit -m "chore: release version ${{ steps.version.outputs.full_version }} [skip ci]"
        
        # Push (usar GH_TOKEN para autenticar)
        git remote set-url origin https://x-access-token:${{ secrets.GH_TOKEN }}@github.com/rodrigolanes/fiz_plantao.git
        git push origin HEAD:main || echo "Nada para commitar"
        
    - name: Criar GitHub Release
      uses: softprops/action-gh-release@v1
      if: startsWith(github.ref, 'refs/tags/') || github.event_name == 'workflow_dispatch'
      with:
        tag_name: ${{ github.event_name == 'workflow_dispatch' && github.event.inputs.tag || github.ref_name }}
        name: Release ${{ steps.version.outputs.version_name }}
        body_path: android/release-notes-pt-BR.txt
        files: |
          build/app/outputs/bundle/release/app-release.aab
          native-debug-symbols.zip
        draft: false
        prerelease: false
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
